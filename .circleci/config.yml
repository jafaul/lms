version: 2.1
orbs:
  python: circleci/python@2

jobs:
  test-python:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Create .env file
          command: |
            echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" > .env
            echo "AWS_S3_REGION_NAME=$AWS_S3_REGION_NAME" >> .env
            echo "AWS_S3_SIGNATURE_NAME=$AWS_S3_SIGNATURE_NAME" >> .env
            echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> .env
            echo "AWS_STORAGE_BUCKET_NAME=$AWS_STORAGE_BUCKET_NAME" >> .env
            echo "DB_HOST=$DB_HOST" >> .env
            echo "DB_NAME=$DB_NAME" >> .env
            echo "DB_PASSWORD=$DB_PASSWORD" >> .env
            echo "DB_PORT=$DB_PORT" >> .env
            echo "DB_USERNAME=$DB_USERNAME" >> .env
            echo "DEBUG=$DEBUG" >> .env
            echo "DJANGO_DEBUG=$DJANGO_DEBUG" >> .env
            echo "DJANGO_PROJECT_PORT=$DJANGO_PROJECT_PORT" >> .env
            echo "DJANGO_SECRET_KEY=$DJANGO_SECRET_KEY" >> .env
            echo "DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE" >> .env
            echo "EMAIL_HOST=$EMAIL_HOST" >> .env
            echo "EMAIL_HOST_PASSWORD=$EMAIL_HOST_PASSWORD" >> .env
            echo "EMAIL_HOST_USER=$EMAIL_HOST_USER" >> .env
            echo "EMAIL_PORT=$EMAIL_PORT" >> .env
            echo "EMAIL_USE_TLS=$EMAIL_USE_TLS" >> .env
            echo "REDIS_ADDR=$REDIS_ADDR" >> .env
            echo "SOCIAL_AUTH_GOOGLE_OAUTH2_KEY=$SOCIAL_AUTH_GOOGLE_OAUTH2_KEY" >> .env
            echo "SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET=$SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET" >> .env

      - python/install-packages:
          pkg-manager: poetry

      - run:
          name: Install Docker Compose
          command: |
            sudo apt-get update
            DEBIAN_FRONTEND=noninteractive sudo apt-get install -y ca-certificates curl
            install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
            chmod a+r /etc/apt/keyrings/docker.asc

            # Add the repository to Apt sources:
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
              $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
              sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt-get update
            DEBIAN_FRONTEND=noninteractive sudo apt-get install docker-ce-cli docker-buildx-plugin docker-compose-plugin

      - setup_remote_docker: #activate the remote docker environment
          version: edge
          docker_layer_caching: true

      - run:
          name: Run tests poetry
          command: make test

workflows:
  build-and-test:
    jobs:
      - test-python
